<% layout("/layouts/boilerplate") %>

  <section id="form-page">
    <div class="container form-container">

      <form class="listing-form" action="/listings/<%= listing._id %>/edit" method="POST" enctype="multipart/form-data">
        <h2 class="form-title">Edit Listing</h2>

        <label for="listing-title">Title</label>
        <input class="form-input" name="listing[title]" value="<%= listing.title %>" required>

        <label for="listing-description">Description</label>
        <input class="form-input" name="listing[description]" value="<%= listing.description %>" required>

        <label>Current Images</label>
        <div class="current-images-grid" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
          <% listing.image.forEach((img, index)=> { %>
            <div class="current-image-wrapper" style="position: relative;">
              <img src="<%= img %>" class="preview-img"
                style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;">
              <div style="text-align: center; margin-top: 5px;">
                <input type="checkbox" id="img-<%= index %>" name="deleteImages[]" value="<%= img %>">
                <label for="img-<%= index %>" style="font-size: 12px;">Delete</label>
              </div>
            </div>
            <% }) %>
        </div>

        <label>Upload New Images</label>
        <div id="image-upload-wrapper">
          <div class="image-input-group">
            <input class="form-input" type="file" name="listing[image]" multiple onchange="previewAllImages()">
          </div>
        </div>
        <button type="button" class="btn-add-image" onclick="addImageField()">+ Add Another Image</button>
        <div id="image-preview" class="image-preview-container"></div>
        <br>
        <label for="listing-price">Price</label>
        <input class="form-input" type="number" name="listing[price]" value="<%= listing.price %>" required>

        <label for="listing-location">Location</label>
        <input class="form-input" name="listing[location]" value="<%= listing.location %>">

        <label for="listing-country">Country</label>
        <input class="form-input" name="listing[country]" value="<%= listing.country %>">

        <button class="form-btn" type="submit">Update</button>
      </form>

    </div>
  </section>

  <script>
    function addImageField() {
      const wrapper = document.getElementById('image-upload-wrapper');
      const div = document.createElement('div');
      div.className = 'image-input-group';
      div.style.marginTop = "10px";
      div.innerHTML = `
        <input class="form-input" type="file" name="listing[image]" multiple onchange="previewAllImages()">
      `;
      wrapper.appendChild(div);
    }

    function previewAllImages() {
      const previewContainer = document.getElementById('image-preview');
      previewContainer.innerHTML = '';

      const inputs = document.querySelectorAll('input[name="listing[image]"]');

      inputs.forEach(input => {
        if (input.files) {
          Array.from(input.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function (e) {
              const img = document.createElement('img');
              img.src = e.target.result;
              img.classList.add('preview-img');
              previewContainer.appendChild(img);
            }
            reader.readAsDataURL(file);
          });
        }
      });
    }
  </script>

  </div>
  </section>